<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Portafolio estático de Jamileth Jackelinne Guerra Aguilar con estrategia, diseño, websites y fraguas de ideas.">
  <meta name="keywords" content="estrategia, diseño, websites, publicidad, Jamileth Guerra, portafolio, AI Hybrid">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://jamileth-jactsu.example/">
  <meta property="og:title" content="Portafolio - Jamileth Jackelinne Guerra Aguilar">
  <meta property="og:description" content="Estrategia, diseño, websites, varios y fraguas de ideas en un solo lugar.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://jamileth-jactsu.example/">
  <meta property="og:image" content="https://c.animaapp.com/AONx6myv/img/mask-group@2x.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Portafolio - Jamileth Jackelinne Guerra Aguilar">
  <meta name="twitter:description" content="Explora estrategia, diseño, websites y fraguas de ideas.">
  <meta name="twitter:image" content="https://c.animaapp.com/AONx6myv/img/mask-group@2x.png">
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "Jamileth Jackelinne Guerra Aguilar",
      "jobTitle": "Estratega Publicitaria & AI Hybrid",
      "url": "https://jamileth-jactsu.example/",
      "sameAs": ["https://www.linkedin.com", "https://www.behance.net"],
      "knowsAbout": ["estrategia", "diseño", "website", "varios", "fraguas"],
      "image": "https://c.animaapp.com/AONx6myv/img/mask-group@2x.png"
    }
  </script>
  <title>PAD - Jamileth Jackelinne Guerra Aguilar</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@1,600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
            playfair: ['Playfair Display', 'serif'],
          },
          colors: {
            brand: {
              primary: '#0087FC',
              secondary: '#0076C7',
              dark: '#005E91',
              bg: '#F2F6FF',
              text: '#001D26',
              accent: '#C12D2D'
            },
            dark: {
              bg: '#000000',
              card: 'rgba(0, 0, 0, 0.6)',
              border: 'rgba(0, 135, 252, 0.3)',
              text: '#FFFFFF',
              subtext: '#E5E5E5',
              highlight: '#38bdf8'
            }
          },
          boxShadow: {
            'neon': '0 0 10px rgba(0, 135, 252, 0.15), 0 0 20px rgba(0, 135, 252, 0.1)',
          },
          animation: {
            'fade-in': 'fadeIn 0.8s ease-out forwards',
            'slide-up': 'slideUp 0.6s ease-out forwards',
            'progress': 'progress 1.5s ease-out forwards',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
            slideUp: { '0%': { opacity: '0', transform: 'translateY(30px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
            progress: { '0%': { width: '0' } }
          }
        }
      }
    }
  </script>
  <style>
    .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    .dark .glass-effect { background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0, 135, 252, 0.2); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .dark input[type="date"], .dark input[type="file"] { color-scheme: dark; }
  </style>
</head>
<body class="bg-white dark:bg-dark-bg font-inter text-brand-text dark:text-dark-text antialiased overflow-x-hidden transition-colors duration-300">
  <div class="fixed top-0 left-0 w-full h-[600px] bg-gradient-to-b from-blue-50 to-white dark:from-black dark:to-dark-bg -z-10 pointer-events-none opacity-60"></div>

  <header class="fixed top-6 left-0 right-0 z-50 px-4">
    <nav class="glass-effect border border-[#b6d0ff] dark:border-dark-border rounded-full shadow px-4 md:px-6 py-3 max-w-[965px] h-[54px] mx-auto flex items-center justify-between transition-all duration-300">
      <h1 id="pageTitle" class="text-base md:text-xl font-bold text-brand-dark dark:text-brand-primary tracking-[-0.5px] leading-5 cursor-pointer">PAD · Inicio</h1>
      <div class="flex items-center gap-2">
        <button data-view="HOME" class="nav-btn px-3 md:px-4 h-8 md:h-9 rounded-full font-semibold text-xs md:text-sm leading-5 transition-all duration-300">Inicio</button>
        <button data-view="PORTFOLIO" class="nav-btn px-3 md:px-4 h-8 md:h-9 rounded-full font-semibold text-xs md:text-sm leading-5 transition-all duration-300">Portafolio</button>
        <button data-view="CHATBOT" class="nav-btn px-3 md:px-4 h-8 md:h-9 rounded-full font-semibold text-xs md:text-sm leading-5 transition-all duration-300">ChatBot</button>
        <button data-view="CPANEL" class="nav-btn hidden sm:inline px-2 text-[10px] font-mono opacity-70 hover:opacity-100" title="Panel de Control">CP</button>
        <button id="darkToggle" class="ml-1 p-1.5 rounded-full text-brand-dark dark:text-white hover:bg-gray-100 dark:hover:bg-white/10 transition-colors" title="Modo oscuro">
          <svg id="sunIcon" class="w-4 h-4 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
          <svg id="moonIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
        </button>
      </div>
    </nav>
  </header>

  <main class="pt-24 md:pt-[110px]">
    <section id="homeSection" class="min-h-screen px-4 md:px-6 max-w-[1080px] mx-auto pb-16"></section>
    <section id="portfolioSection" class="hidden min-h-screen px-4 md:px-6 max-w-[1200px] mx-auto pb-16"></section>
    <section id="chatbotSection" class="hidden min-h-screen px-4 md:px-6 max-w-[1000px] mx-auto pb-16"></section>
    <section id="cvSection" class="hidden min-h-screen px-4 md:px-6 max-w-[1100px] mx-auto pb-16"></section>
    <section id="cpanelSection" class="hidden min-h-screen px-4 md:px-6 max-w-[900px] mx-auto pb-16"></section>
  </main>

  <footer class="border-t border-[#b6d0ff]/50 dark:border-dark-border mt-auto py-6 text-center text-sm text-slate-600 dark:text-dark-subtext">
    <p>Jamileth Jackelinne Guerra Aguilar · Estratega Publicitaria & AI Hybrid</p>
  </footer>

  <div id="projectModal" class="hidden fixed inset-0 z-[100] items-center justify-center p-4">
    <div class="absolute inset-0 bg-white/80 dark:bg-black/80 backdrop-blur-md"></div>
    <div class="relative bg-white dark:bg-black border border-[#b6d0ff] dark:border-white/20 w-full max-w-4xl max-h-[90vh] rounded-3xl shadow-2xl overflow-y-auto">
      <button id="closeModal" class="absolute top-4 right-4 z-10 p-2 bg-white/50 dark:bg-black/50 rounded-full hover:bg-white dark:hover:bg-dark-card transition-colors">
        <svg class="w-6 h-6 text-brand-dark dark:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
      <div id="modalContent"></div>
    </div>
  </div>

  <script>
    const persona = {
      name: "Jamileth Jackelinne Guerra Aguilar",
      role: "Estratega Publicitaria & AI Hybrid",
      cedula: "8-1008-914",
      age: "21 años",
      status: "Soltera",
      location: "Panamá, Villa Daniela",
      phone1: "6604-3511",
      phone2: "6530-0791",
      quote: "Si tienes un problema, y puedes definirlo, ya tienes la mitad resuelto.",
      image: "https://c.animaapp.com/AONx6myv/img/mask-group@2x.png",
      fichaPersonal: { carrera: "Lic. Publicidad", curso: "Cámara reportaje", diplomado: "IE y Comunicación Empática" },
      intereses: { pasion: "Folclore panameño", hobby: "Videojuegos, Aprendizaje continuo" },
      pro: { motivacion: "Trascender, Coherencia, Curiosidad", oportunidad: "Emoción+razón, Autenticidad+valor", deseo: "Libertad, Inspirar a otros, Conectar mentes" },
      contra: { frustracion: "Incomprensión, Desorden, Autoexigencia", miedo: "Estancamiento, Ruido mental" }
    };

    const discData = [
      { name: 'Dominio', percentage: 32 },
      { name: 'Influencia', percentage: 25 },
      { name: 'Estabilidad', percentage: 20 },
      { name: 'Cumplimiento', percentage: 23 },
    ];

    const competencies = [
      { name: 'Análisis Estratégico & Pensamiento Crítico', percentage: 85 },
      { name: 'Resiliencia', percentage: 78 },
      { name: 'Toma de decisiones', percentage: 80 },
      { name: 'Adaptabilidad Tecnológica', percentage: 95 },
      { name: 'Liderazgo & Trabajo en Equipo', percentage: 90 },
    ];

    const STORAGE_KEY = 'jjga-portfolio-v2';
    const CATEGORY_OPTIONS = ['estrategia', 'diseño', 'website', 'varios', 'fraguas'];
    const uploadDir = 'uploads';
    const BRIEF_FIELDS = [
      { key: 'antecedentes', label: 'Antecedentes' },
      { key: 'historiaProducto', label: 'Historia del producto' },
      { key: 'caracteristicas', label: 'Características' },
      { key: 'beneficios', label: 'Beneficios' },
      { key: 'distribucion', label: 'Distribución' },
      { key: 'target', label: 'Target' },
      { key: 'posicionamiento', label: 'Posicionamiento' },
      { key: 'precio', label: 'Precio' },
      { key: 'medio', label: 'Medio' },
      { key: 'competencia', label: 'Competencia' }
    ];
    const FLOW_FIELDS = [
      { key: 'objetivo', label: 'Objetivo' },
      { key: 'estrategiaMedios', label: 'Estrategia de medios' },
      { key: 'presupuesto', label: 'Presupuesto' },
      { key: 'medidas', label: 'KPIs / Medidas' }
    ];

    const MEDIA_PLAN_CONFIG = {
      IMPRESO: {
        label: 'Impreso',
        commission: 0.15,
        fields: [
          { key: 'medio', label: 'Medio impreso' },
          { key: 'dia', label: 'Día de pauta' },
          { key: 'formato', label: 'Formato' },
          { key: 'tamano', label: 'Tamaño' },
          { key: 'veces', label: 'Número de veces', type: 'number' },
          { key: 'tamanoPulgadas', label: 'Pulgadas columnares', type: 'number' },
          { key: 'precioPulgadas', label: 'Precio por pulg. col.', type: 'number' }
        ],
        total: row => (Number(row.veces || 0) * Number(row.tamanoPulgadas || 0) * Number(row.precioPulgadas || 0))
      },
      TV: {
        label: 'Televisión',
        commission: 0.15,
        fields: [
          { key: 'programa', label: 'Programa' },
          { key: 'dia', label: 'Día de pauta' },
          { key: 'horario', label: 'Horario' },
          { key: 'tiempo', label: 'Tiempo al aire' },
          { key: 'repeticion', label: 'Repetición', type: 'number' },
          { key: 'costo', label: 'Costo', type: 'number' },
          { key: 'ratingPoint', label: 'Rating point', type: 'number', helper: 'Para calcular CPM y CPPR' }
        ],
        total: row => (Number(row.repeticion || 0) || 1) * Number(row.costo || 0)
      },
      RADIO: {
        label: 'Radio',
        commission: 0.18,
        fields: [
          { key: 'programa', label: 'Programa' },
          { key: 'dia', label: 'Día de pauta' },
          { key: 'horario', label: 'Horario' },
          { key: 'tiempo', label: 'Tiempo' },
          { key: 'repeticion', label: 'Repetición', type: 'number' },
          { key: 'costo', label: 'Costo', type: 'number' }
        ],
        total: row => (Number(row.repeticion || 0) || 1) * Number(row.costo || 0)
      },
      VAYA: {
        label: 'Valla',
        commission: 0.15,
        fields: [
          { key: 'caracteristica', label: 'Característica' },
          { key: 'tiempo', label: 'Tiempo' },
          { key: 'numeroVallas', label: 'Número de vallas', type: 'number' },
          { key: 'costo', label: 'Costo', type: 'number' }
        ],
        total: row => Number(row.numeroVallas || 0) * Number(row.costo || 0)
      },
      REDES: {
        label: 'Redes',
        commission: 0.25,
        fields: [
          { key: 'medio', label: 'Medio' },
          { key: 'tiempo', label: 'Tiempo' },
          { key: 'publicaciones', label: 'Número de publicaciones', type: 'number' },
          { key: 'costo', label: 'Costo', type: 'number' }
        ],
        total: row => Number(row.publicaciones || 0) * Number(row.costo || 0)
      },
      FLYER: {
        label: 'Flyer',
        commission: 0.15,
        fields: [
          { key: 'formato', label: 'Formato' },
          { key: 'tiempo', label: 'Tiempo' },
          { key: 'cantidad', label: 'Cantidad', type: 'number' },
          { key: 'costo', label: 'Costo', type: 'number' }
        ],
        total: row => Number(row.cantidad || 0) * Number(row.costo || 0)
      }
    };

    function createEmptyPlanRow(medium = 'IMPRESO') {
      const cfg = MEDIA_PLAN_CONFIG[medium] || MEDIA_PLAN_CONFIG.IMPRESO;
      const row = { medium };
      cfg.fields.forEach(f => { row[f.key] = ''; });
      return row;
    }

    function computePlanRowTotal(row = {}) {
      const medium = row.medium || 'IMPRESO';
      const cfg = MEDIA_PLAN_CONFIG[medium] || MEDIA_PLAN_CONFIG.IMPRESO;
      return cfg.total ? cfg.total(row) : 0;
    }

    function computePlanSummary(rows = []) {
      const totals = {};
      rows.forEach(row => {
        const medium = row.medium || 'IMPRESO';
        const value = computePlanRowTotal(row);
        totals[medium] = (totals[medium] || 0) + value;
      });
      const summary = Object.entries(totals).map(([medium, total]) => {
        const commissionRate = MEDIA_PLAN_CONFIG[medium]?.commission || 0;
        const commission = total * commissionRate;
        return { medium, total, commission };
      });
      const grandTotal = summary.reduce((acc, item) => acc + item.total, 0);
      const commissionTotal = summary.reduce((acc, item) => acc + item.commission, 0);
      return { summary, grandTotal, commissionTotal };
    }

    function formatCurrency(value = 0) {
      return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }).format(value || 0);
    }

    function serializePlanRow(row = {}) {
      const medium = (row.medium || 'IMPRESO').toUpperCase();
      const cfg = MEDIA_PLAN_CONFIG[medium] || MEDIA_PLAN_CONFIG.IMPRESO;
      const payload = { medium };
      cfg.fields.forEach(f => { payload[f.key] = row[f.key] || ''; });
      const total = computePlanRowTotal(row);
      payload.total = total;
      if (row.ratingPoint !== undefined && row.ratingPoint !== '') {
        const rating = Number(row.ratingPoint) || 0;
        const cost = Number(row.costo || total || 0);
        payload.ratingPoint = row.ratingPoint;
        payload.cpm = rating ? cost / (rating * 1000) : 0;
        payload.cppr = rating ? cost / rating : 0;
      }
      return payload;
    }

    const seedProjects = [
      {
        id: '1',
        title: 'Plan Aurora 2025',
        subtitle: 'Replanteamiento estratégico para la expansión de Visela en LATAM con enfoque data-driven y adopción progresiva de IA.',
        category: 'estrategia',
        tags: ['may 2025', 'Real'],
        thumbnailUrl: 'https://images.unsplash.com/photo-1460925895917-afdab827c52f?q=80&w=2426&auto=format&fit=crop',
        date: '2025-05-01',
        updatedAt: Date.now() - 1000 * 60 * 60 * 24 * 30,
        draft: false,
        sections: [
          { id: 's1', title: 'Introducción', type: 'TEXT', content: 'Visela busca expandir su cuota de mercado en Latinoamérica utilizando tecnologías emergentes.' },
          { id: 's2', title: 'Brief Estratégico', type: 'BRIEF', content: { antecedentes: 'Empresa líder en software B2B en Europa, poca presencia en LATAM.', historiaProducto: 'Suite de gestión creada en 2010.', caracteristicas: 'SaaS, Modular, AI-integrated.', beneficios: 'Optimización de flujos de trabajo en un 40%.', distribucion: 'Venta directa digital y partners locales.', target: 'CTOs y Gerentes de Operaciones en empresas medianas.', posicionamiento: 'La solución más inteligente para escalar.', precio: 'Suscripción Tiered (Basic, Pro, Enterprise).', medio: 'LinkedIn Ads, Webinars, SEO.', competencia: 'SAP, Oracle (en segmento alto), soluciones locales.' } }
        ]
      },
      {
        id: '2',
        title: 'Identidad Nova',
        subtitle: 'Sistema visual retrofuturista para una fintech de economía circular.',
        category: 'diseño',
        tags: ['nov 2024', 'Ficticio'],
        thumbnailUrl: 'https://images.unsplash.com/photo-1550751827-4bd374c3f58b?q=80&w=2670&auto=format&fit=crop',
        date: '2024-11-01',
        updatedAt: Date.now() - 1000 * 60 * 60 * 24 * 60,
        draft: false,
        sections: [ { id: 's1', title: 'Concepto Visual', type: 'TEXT', content: 'Fusión de estética 80s con minimalismo moderno para denotar sostenibilidad y tecnología.' } ]
      },
      {
        id: '3',
        title: 'Órbita Dashboard',
        subtitle: 'Rediseño de dashboard modular con foco en experiencias micro-interactivas y accesibilidad AA.',
        category: 'website',
        tags: ['ene 2025', 'Estudio de Caso'],
        thumbnailUrl: 'https://images.unsplash.com/photo-1551288049-bebda4e38f71?q=80&w=2670&auto=format&fit=crop',
        date: '2025-01-15',
        updatedAt: Date.now() - 1000 * 60 * 60 * 24 * 10,
        draft: false,
        sections: []
      },
      {
        id: '4',
        title: 'Pulse Activación 360°',
        subtitle: 'Activación inmersiva con realidad mixta para lanzar la línea Pulse Experience.',
        category: 'varios',
        tags: ['sept 2023', 'Real'],
        thumbnailUrl: 'https://images.unsplash.com/photo-1626379953822-baec19c3accd?q=80&w=2670&auto=format&fit=crop',
        date: '2023-09-10',
        updatedAt: Date.now() - 1000 * 60 * 60 * 24 * 300,
        draft: false,
        sections: [ { id: 'f1', title: 'Flowchart del Evento', type: 'FLOWCHART', content: { objetivo: 'Lograr 500 demos en vivo durante el fin de semana de lanzamiento.', estrategiaMedios: 'Campaña teaser en Instagram + Influencers Tech.', presupuesto: '$15,000 USD', medidas: 'KPIs: Foot traffic, Demos completados, Social Mentions.' } } ]
      },
      {
        id: '5',
        title: 'Bitácora de Fragua',
        subtitle: 'Notas de investigación rápida con feedback de la comunidad.',
        category: 'fraguas',
        tags: ['abr 2025', 'Borrador'],
        thumbnailUrl: 'https://images.unsplash.com/photo-1522202176988-66273c2fd55f?q=80&w=2670&auto=format&fit=crop',
        date: '2025-04-02',
        updatedAt: Date.now() - 1000 * 60 * 60 * 24 * 20,
        draft: false,
        sections: [ { id: 'fg1', title: 'Entrada inicial', type: 'TEXT', content: 'Discusión abierta para ideas rápidas y feedback tipo foro.' } ],
        isIdeaForge: true
      }
    ];

    function loadProjects() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          if (Array.isArray(parsed)) return parsed;
        }
      } catch (e) {}
      saveProjects(seedProjects);
      return seedProjects;
    }

    function saveProjects(list = projects) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
      } catch (e) {}
    }

    let projects = loadProjects();
    let sectionDrafts = [];
    let assetDrafts = [];
    let editingId = null;

    function createEmptySection(type = 'TEXT') {
      return {
        id: Date.now().toString(),
        type,
        title: '',
        body: '',
        brief: BRIEF_FIELDS.reduce((acc, f) => ({ ...acc, [f.key]: '' }), {}),
        flow: FLOW_FIELDS.reduce((acc, f) => ({ ...acc, [f.key]: '' }), {}),
        mediaPlan: [createEmptyPlanRow()],
        evento: '',
        lugar: '',
        fecha: '',
        mediaUrl: '',
        mediaType: 'imagen'
      };
    }

    function normalizeCategory(cat = '') {
      return cat.toLowerCase();
    }

    function formatCategory(cat = '') {
      const value = normalizeCategory(cat);
      if (value === 'diseño') return 'Diseño';
      if (value === 'fraguas') return 'Fraguas';
      return value.charAt(0).toUpperCase() + value.slice(1);
    }

    function visibleProjects() {
      const now = Date.now();
      return projects.filter(p => !p.draft && (!p.scheduledAt || p.scheduledAt <= now));
    }

    function processSchedules() {
      const now = Date.now();
      let changed = false;
      projects = projects.map(p => {
        if (p.scheduledAt && now >= p.scheduledAt) {
          changed = true;
          return { ...p, draft: false, scheduledAt: null, updatedAt: now };
        }
        return p;
      });
      if (changed) {
        saveProjects();
        renderPortfolio();
        if (typeof window.renderProjectList === 'function') window.renderProjectList();
      }
    }

    setInterval(processSchedules, 30000);

    let currentView = 'HOME';
    const navButtons = document.querySelectorAll('.nav-btn');
    const sections = {
      HOME: document.getElementById('homeSection'),
      PORTFOLIO: document.getElementById('portfolioSection'),
      CHATBOT: document.getElementById('chatbotSection'),
      CV: document.getElementById('cvSection'),
      CPANEL: document.getElementById('cpanelSection')
    };
    const viewTitles = {
      HOME: 'Inicio',
      PORTFOLIO: 'Portafolio',
      CHATBOT: 'ChatBot',
      CV: 'CV interactivo',
      CPANEL: 'CPanel'
    };

    function updateNav() {
      document.getElementById('pageTitle').textContent = `PAD · ${viewTitles[currentView] || 'Inicio'}`;
      navButtons.forEach(btn => {
        const target = btn.dataset.view;
        btn.classList.remove('bg-brand-primary','text-white','shadow-md','underline','opacity-100');
        if (target === currentView) {
          btn.classList.add('bg-brand-primary','text-white','shadow-md');
        } else {
          btn.classList.add('text-brand-dark','dark:text-dark-text');
        }
      });
      Object.entries(sections).forEach(([key, el]) => {
        if (el) el.classList.toggle('hidden', key !== currentView);
      });
    }

    navButtons.forEach(btn => btn.addEventListener('click', () => {
      const nextView = btn.dataset.view;
      if (currentView === 'CPANEL' && nextView !== 'CPANEL' && typeof window.lockPanelSession === 'function') {
        window.lockPanelSession();
      }
      currentView = nextView;
      updateNav();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }));

    function toggleDarkMode() {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('prefers-dark', isDark ? '1' : '0');
      document.getElementById('sunIcon').classList.toggle('hidden', !isDark);
      document.getElementById('moonIcon').classList.toggle('hidden', isDark);
    }

    document.getElementById('darkToggle').addEventListener('click', toggleDarkMode);
    if (localStorage.getItem('prefers-dark') === '1') toggleDarkMode();

    function renderProfile() {
      const container = document.getElementById('homeSection');
      container.innerHTML = `
        <div class="hidden lg:block relative h-[673px]">
          <div class="absolute left-[25px] top-[26px] bg-brand-primary rounded-md w-16 h-6 flex items-center justify-center z-20">
            <span class="text-white text-xs font-bold">PERFIL</span>
          </div>
          <div class="bg-white dark:bg-dark-card border border-[#f2f6ff] dark:border-dark-border rounded-2xl w-[518px] h-[449px] absolute left-0 top-0 overflow-visible shadow-sm">
            <h2 class="absolute left-[25px] top-[62px] text-4xl font-bold text-brand-dark dark:text-brand-secondary leading-[45px] tracking-[-0.5px]">Jamileth</h2>
            <h2 class="absolute left-[25px] top-[107px] text-4xl font-bold text-brand-dark dark:text-brand-secondary leading-[45px] tracking-[-0.5px]">Jackelinne</h2>
            <h3 class="absolute left-[25px] top-[156px] text-[30px] font-bold text-brand-secondary dark:text-brand-primary leading-[38px] tracking-[-0.5px]">Guerra Aguilar</h3>
            <p class="absolute left-[25px] top-[210px] text-sm font-semibold text-brand-dark dark:text-brand-secondary leading-5">${persona.role}</p>
            <div class="absolute left-[25px] top-[254px] w-[230px] h-[50px] bg-brand-bg dark:bg-dark-bg rounded-lg">
              <p class="absolute left-2 top-2 text-xs font-semibold text-brand-secondary dark:text-brand-primary leading-4">CÉDULA</p>
              <p class="absolute left-2 top-[26px] text-xs font-semibold text-brand-text dark:text-white leading-4">${persona.cedula}</p>
            </div>
            <div class="absolute left-[263px] top-[254px] w-[230px] h-[50px] bg-brand-bg dark:bg-dark-bg rounded-lg">
              <p class="absolute left-2 top-2 text-xs font-semibold text-brand-secondary dark:text-brand-primary leading-4">EDAD</p>
              <p class="absolute left-2 top-[26px] text-xs font-semibold text-brand-text dark:text-white leading-4">${persona.age}</p>
            </div>
            <div class="absolute left-[25px] top-[312px] w-[230px] h-[50px] bg-brand-bg dark:bg-dark-bg rounded-lg">
              <p class="absolute left-2 top-2 text-xs font-semibold text-brand-secondary dark:text-brand-primary leading-4">ESTADO</p>
              <p class="absolute left-2 top-[26px] text-xs font-semibold text-brand-text dark:text-white leading-4">${persona.status}</p>
            </div>
            <div class="absolute left-[263px] top-[312px] w-[230px] h-[50px] bg-brand-bg dark:bg-dark-bg rounded-lg">
              <p class="absolute left-2 top-2 text-xs font-semibold text-brand-secondary dark:text-brand-primary leading-4">UBICACIÓN</p>
              <p class="absolute left-2 top-[26px] text-xs font-semibold text-brand-text dark:text-white leading-4">${persona.location}</p>
            </div>
            <div class="absolute left-[25px] top-[371px] border-t border-[#f2f6ff] dark:border-dark-border w-[469px] h-[61px]">
              <p class="absolute left-[2px] top-[11px] text-xs font-semibold text-brand-secondary dark:text-brand-primary leading-4">CONTACTO</p>
              <p class="absolute left-[2px] top-[33px] text-xs font-semibold text-brand-secondary dark:text-brand-secondary leading-4">${persona.phone1}</p>
              <p class="absolute left-[2px] top-[51px] text-xs font-semibold text-brand-secondary dark:text-brand-secondary leading-4">${persona.phone2}</p>
            </div>
            <div class="absolute left-[156px] top-[382px] bg-brand-bg dark:bg-dark-bg border border-[#f2f6ff] dark:border-dark-border rounded-[10px] w-[344px] h-[57px] flex flex-col items-center justify-center">
              <p class="text-[11.5px] font-semibold text-brand-dark dark:text-brand-secondary font-playfair italic text-center leading-3 tracking-[-0.02em] w-[333px]">${persona.quote}</p>
              <p class="text-[9px] italic font-light text-brand-dark dark:text-brand-primary mt-1">Filosofía Personal</p>
            </div>
            <img src="${persona.image}" alt="Profile" class="absolute top-[-22px] left-[249px] w-[276px] h-[272px] object-cover pointer-events-none rounded-full z-10 shadow-[0_0_30px_rgba(0,135,252,0.4)] dark:shadow-[0_0_50px_rgba(0,135,252,0.8)]" />
          </div>
          <div class="bg-white dark:bg-dark-card border border-[#f2f6ff] dark:border-dark-border rounded-2xl w-[452px] h-[181px] absolute left-[538px] top-0 shadow-sm">
            <h3 class="absolute left-[21px] top-5 text-xs font-semibold text-brand-secondary dark:text-brand-primary leading-4">PERFIL DISC</h3>
            <div class="grid grid-cols-2 gap-x-[30px] gap-y-4 absolute left-[21px] top-[48px]">
              ${discData.map(item => `
                <div class="disc-item">
                  <p class="text-xs font-semibold text-brand-dark dark:text-brand-secondary leading-4 mb-[5px]">${item.name}</p>
                  <div class="w-[200px] h-1 bg-brand-bg dark:bg-dark-bg rounded-full overflow-hidden">
                    <div class="h-full bg-brand-secondary rounded-full animate-progress" style="width:${item.percentage}%"></div>
                  </div>
                  <p class="text-xs font-bold text-brand-secondary dark:text-brand-primary leading-4 mt-1">${item.percentage}%</p>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="bg-white dark:bg-dark-card border border-[#f2f6ff] dark:border-dark-border rounded-2xl w-[452px] h-[261px] absolute left-[538px] top-[188px] shadow-sm">
            <h3 class="absolute left-[27px] top-5 text-sm font-semibold text-brand-secondary dark:text-brand-primary leading-4">COMPETENCIAS</h3>
            <div class="absolute left-0 top-[52px] w-full">
              ${competencies.map(comp => `
                <div class="flex items-center justify-between h-[31px] border-b border-[#f2f6ff] dark:border-dark-border px-[27px]">
                  <p class="text-[13px] font-semibold text-brand-dark dark:text-brand-secondary leading-5">${comp.name}</p>
                  <span class="bg-brand-primary text-white text-xs font-bold leading-4 px-3 h-[21px] rounded flex items-center justify-center">${comp.percentage}%</span>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="grid grid-cols-4 gap-[33px] absolute left-[9px] top-[470px] w-full">
            <div class="text-[11px] text-brand-secondary dark:text-brand-secondary leading-4">
              <span class="font-bold dark:text-brand-primary text-xs">FICHA PERSONAL</span><br/>
              <span class="font-medium text-brand-text dark:text-dark-text">Carrera:</span> <span class="font-light text-brand-text dark:text-dark-subtext">${persona.fichaPersonal.carrera}</span><br/>
              <span class="font-medium text-brand-text dark:text-dark-text">Curso:</span> <span class="font-light text-brand-text dark:text-dark-subtext">${persona.fichaPersonal.curso}</span><br/>
              <span class="font-medium text-brand-text dark:text-dark-text">Diplomado:</span> <span class="font-light text-brand-text dark:text-dark-subtext">${persona.fichaPersonal.diplomado}</span>
            </div>
            <div class="text-[11px] text-brand-secondary dark:text-brand-secondary leading-4">
              <span class="font-bold dark:text-brand-primary text-xs">INTERESES</span><br/>
              <span class="font-medium text-brand-text dark:text-dark-text">Pasión:</span> <span class="font-light text-brand-text dark:text-dark-subtext">${persona.intereses.pasion}</span><br/>
              <span class="font-medium text-brand-text dark:text-dark-text">Hobby:</span> <span class="font-light text-brand-text dark:text-dark-subtext">${persona.intereses.hobby}</span>
            </div>
            <div class="text-[11px] text-brand-secondary dark:text-brand-secondary leading-4">
              <span class="font-bold dark:text-brand-primary text-xs">PRO</span><br/>
              <span class="font-medium text-brand-text dark:text-dark-text">Motivación:</span> <span class="font-light text-brand-text dark:text-dark-subtext">${persona.pro.motivacion}</span><br/>
              <span class="font-medium text-brand-text dark:text-dark-text">Oportunidad:</span> <span class="font-light text-brand-text dark:text-dark-subtext">${persona.pro.oportunidad}</span><br/>
              <span class="font-medium text-brand-text dark:text-dark-text">Deseo:</span> <span class="font-light text-brand-text dark:text-dark-subtext">${persona.pro.deseo}</span>
            </div>
            <div class="text-[11px] text-brand-secondary dark:text-brand-secondary leading-4">
              <span class="font-bold dark:text-brand-primary text-xs">CONTRA</span><br/>
              <span class="font-medium text-brand-text dark:text-dark-text">Frustración:</span> <span class="font-light text-brand-text dark:text-dark-subtext">${persona.contra.frustracion}</span><br/>
              <span class="font-medium text-brand-text dark:text-dark-text">Miedo:</span> <span class="font-light text-brand-text dark:text-dark-subtext">${persona.contra.miedo}</span>
            </div>
          </div>
        </div>
        <div class="lg:hidden flex flex-col gap-4">
          <div class="bg-white dark:bg-dark-card border border-[#f2f6ff] dark:border-dark-border rounded-2xl p-5 shadow-sm">
            <div class="flex flex-col sm:flex-row items-center sm:items-start gap-5">
              <img src="${persona.image}" alt="Profile" class="w-48 h-48 md:w-52 md:h-52 object-cover rounded-full flex-shrink-0 sm:order-2 shadow-[0_0_20px_rgba(0,135,252,0.4)] dark:shadow-[0_0_40px_rgba(0,135,252,0.8)]" />
              <div class="text-center sm:text-left flex-1 sm:order-1">
                <div class="inline-block bg-brand-primary rounded-md px-2 py-1 mb-2"><span class="text-white text-[10px] font-bold leading-3">PERFIL</span></div>
                <h2 class="text-3xl font-bold text-brand-dark dark:text-brand-secondary leading-tight">Jamileth<br/>Jackelinne</h2>
                <h3 class="text-2xl font-bold text-brand-secondary dark:text-brand-primary leading-tight mt-1">Guerra Aguilar</h3>
                <p class="text-sm font-semibold text-brand-dark dark:text-brand-secondary mt-2">${persona.role}</p>
                <div class="grid grid-cols-2 gap-2 mt-4">
                  ${[['CÉDULA', persona.cedula], ['EDAD', persona.age], ['ESTADO', persona.status], ['UBICACIÓN', persona.location]].map(([label,val]) => `
                    <div class="bg-brand-bg dark:bg-dark-bg rounded-lg p-2 text-left">
                      <p class="text-[10px] font-semibold text-brand-secondary dark:text-brand-primary">${label}</p>
                      <p class="text-[10px] font-semibold text-brand-text dark:text-white">${val}</p>
                    </div>`).join('')}
                </div>
                <div class="hidden md:block sm:hidden border-t border-[#f2f6ff] dark:border-dark-border mt-4 pt-3">
                  <p class="text-[10px] font-semibold text-brand-secondary dark:text-brand-primary mb-1">CONTACTO</p>
                  <div class="flex gap-4">
                    <p class="text-sm font-semibold text-brand-dark dark:text-brand-secondary">${persona.phone1}</p>
                    <p class="text-sm font-semibold text-brand-dark dark:text-brand-secondary">${persona.phone2}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white dark:bg-dark-card border border-[#f2f6ff] dark:border-dark-border rounded-2xl p-4 shadow-sm">
              <h3 class="text-xs font-semibold text-brand-secondary dark:text-brand-primary leading-4 mb-4">PERFIL DISC</h3>
              <div class="grid grid-cols-2 gap-x-4 gap-y-3">
                ${discData.map(item => `
                  <div>
                    <p class="text-xs font-semibold text-brand-dark dark:text-brand-secondary leading-4 mb-1">${item.name}</p>
                    <div class="w-full h-1 bg-brand-bg dark:bg-dark-bg rounded-full overflow-hidden">
                      <div class="h-full bg-brand-secondary rounded-full animate-progress" style="width:${item.percentage}%"></div>
                    </div>
                    <p class="text-xs font-bold text-brand-secondary dark:text-brand-primary leading-4 mt-1">${item.percentage}%</p>
                  </div>`).join('')}
              </div>
            </div>
            <div class="bg-white dark:bg-dark-card border border-[#f2f6ff] dark:border-dark-border rounded-2xl p-4 shadow-sm">
              <h3 class="text-sm font-semibold text-brand-secondary dark:text-brand-primary leading-4 mb-3">COMPETENCIAS</h3>
              <div class="space-y-2">
                ${competencies.map(comp => `
                  <div class="flex items-center justify-between border-b border-[#f2f6ff] dark:border-dark-border pb-2">
                    <p class="text-[13px] font-semibold text-brand-dark dark:text-brand-secondary leading-5">${comp.name}</p>
                    <span class="bg-brand-primary text-white text-xs font-bold leading-4 px-3 h-[21px] rounded flex items-center justify-center">${comp.percentage}%</span>
                  </div>`).join('')}
              </div>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white dark:bg-dark-card border border-[#f2f6ff] dark:border-dark-border rounded-2xl p-4 shadow-sm text-[11px] text-brand-secondary dark:text-brand-secondary leading-5">
              <span class="font-bold dark:text-brand-primary text-xs">FICHA PERSONAL</span><br/>
              <span class="font-medium text-brand-text dark:text-dark-text">Carrera:</span> <span class="font-light text-brand-text dark:text-dark-subtext">${persona.fichaPersonal.carrera}</span><br/>
              <span class="font-medium text-brand-text dark:text-dark-text">Curso:</span> <span class="font-light text-brand-text dark:text-dark-subtext">${persona.fichaPersonal.curso}</span><br/>
              <span class="font-medium text-brand-text dark:text-dark-text">Diplomado:</span> <span class="font-light text-brand-text dark:text-dark-subtext">${persona.fichaPersonal.diplomado}</span>
            </div>
            <div class="bg-white dark:bg-dark-card border border-[#f2f6ff] dark:border-dark-border rounded-2xl p-4 shadow-sm text-[11px] text-brand-secondary dark:text-brand-secondary leading-5">
              <span class="font-bold dark:text-brand-primary text-xs">INTERESES</span><br/>
              <span class="font-medium text-brand-text dark:text-dark-text">Pasión:</span> <span class="font-light text-brand-text dark:text-dark-subtext">${persona.intereses.pasion}</span><br/>
              <span class="font-medium text-brand-text dark:text-dark-text">Hobby:</span> <span class="font-light text-brand-text dark:text-dark-subtext">${persona.intereses.hobby}</span>
            </div>
            <div class="bg-white dark:bg-dark-card border border-[#f2f6ff] dark:border-dark-border rounded-2xl p-4 shadow-sm text-[11px] text-brand-secondary dark:text-brand-secondary leading-5">
              <span class="font-bold dark:text-brand-primary text-xs">PRO</span><br/>
              <span class="font-medium text-brand-text dark:text-dark-text">Motivación:</span> <span class="font-light text-brand-text dark:text-dark-subtext">${persona.pro.motivacion}</span><br/>
              <span class="font-medium text-brand-text dark:text-dark-text">Oportunidad:</span> <span class="font-light text-brand-text dark:text-dark-subtext">${persona.pro.oportunidad}</span><br/>
              <span class="font-medium text-brand-text dark:text-dark-text">Deseo:</span> <span class="font-light text-brand-text dark:text-dark-subtext">${persona.pro.deseo}</span>
            </div>
            <div class="bg-white dark:bg-dark-card border border-[#f2f6ff] dark:border-dark-border rounded-2xl p-4 shadow-sm text-[11px] text-brand-secondary dark:text-brand-secondary leading-5">
              <span class="font-bold dark:text-brand-primary text-xs">CONTRA</span><br/>
              <span class="font-medium text-brand-text dark:text-dark-text">Frustración:</span> <span class="font-light text-brand-text dark:text-dark-subtext">${persona.contra.frustracion}</span><br/>
              <span class="font-medium text-brand-text dark:text-dark-text">Miedo:</span> <span class="font-light text-brand-text dark:text-dark-subtext">${persona.contra.miedo}</span>
            </div>
          </div>
        </div>`;
    }

    function buildProjectCard(project, idx) {
      return `<div class="group cursor-pointer" data-id="${project.id}" style="animation-delay:${idx * 100}ms">
        <div class="bg-slate-100 dark:bg-dark-card rounded-2xl overflow-hidden aspect-[4/3] mb-4 relative shadow-sm border border-transparent dark:border-dark-border">
          <img src="${project.thumbnailUrl}" alt="${project.title}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" />
          <div class="absolute top-4 left-4">
            <span class="bg-white/90 dark:bg-black/80 backdrop-blur-sm px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider text-brand-dark dark:text-brand-primary border border-white/20">${formatCategory(project.category)}</span>
          </div>
        </div>
        <div>
          <h3 class="text-2xl font-bold text-brand-dark dark:text-white mb-2 group-hover:text-brand-primary transition-colors">${project.title}</h3>
          <p class="text-slate-600 dark:text-dark-subtext text-sm leading-relaxed mb-3 line-clamp-2">${project.subtitle}</p>
          <div class="flex gap-2 flex-wrap">
            ${(project.tags || []).map(tag => `<span class="bg-blue-50 dark:bg-white/5 text-brand-secondary dark:text-brand-secondary text-xs px-2 py-1 rounded font-medium">${tag}</span>`).join('')}
          </div>
        </div>
      </div>`;
    }

    function renderPortfolio() {
      processSchedules();
      const container = document.getElementById('portfolioSection');
      const liveProjects = visibleProjects();
      const ideaForge = liveProjects.filter(p => p.category === 'fraguas' || p.isIdeaForge).sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0));
      let filtered = liveProjects.filter(p => p.category !== 'fraguas' && !p.isIdeaForge);
      filtered = filtered.sort((a,b) => (b.updatedAt || 0) - (a.updatedAt || 0));
      container.innerHTML = `
        <div class="text-center mb-12">
          <div class="inline-block border border-[#b6d0ff] dark:border-brand-primary/50 rounded-full px-6 py-1 mb-6">
            <span class="text-xs font-bold tracking-[0.2em] text-brand-dark dark:text-brand-primary uppercase">Jamileth J. Guerra</span>
          </div>
          <h1 class="text-4xl md:text-6xl font-bold text-brand-dark dark:text-white mb-6 leading-tight">Todas las ideas = <span class="text-brand-primary">Pensar, Crear & Transformar</span></h1>
          <p class="text-slate-600 dark:text-dark-subtext max-w-2xl mx-auto text-lg">Explora las diferentes facetas de mi trabajo: Estrategia, Diseño, Websites o Activaciones.</p>
        </div>
        <div class="mb-10 rounded-full px-5 md:px-8 py-4 bg-gradient-to-r from-brand-primary/15 via-white to-brand-primary/10 dark:from-dark-card dark:via-black dark:to-dark-card border border-[#b6d0ff]/60 dark:border-dark-border shadow-sm flex items-center justify-between gap-4">
          <div class="flex-1">
            <p class="text-[11px] uppercase tracking-[0.25em] text-brand-primary font-bold mb-1">CV interactivo</p>
            <p class="text-base md:text-lg text-brand-dark dark:text-white font-semibold">Descubre mi trayectoria en un formato ágil y visual.</p>
          </div>
          <button id="cvBannerBtn" class="px-4 py-2 rounded-full bg-brand-primary text-white font-semibold shadow">Ver CV</button>
        </div>
        <div class="flex justify-center mb-12">
          <div class="bg-white dark:bg-dark-card border border-[#b6d0ff] dark:border-dark-border rounded-full p-1.5 flex flex-wrap justify-center gap-1 shadow-sm" id="filterButtons"></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-20" id="projectGrid"></div>
        <div class="border-t border-[#b6d0ff] dark:border-dark-border pt-16">
          <h2 class="text-3xl font-bold text-brand-dark dark:text-white mb-8 text-center italic font-playfair">"Fraguas de ideas"</h2>
          <p class="text-center text-slate-500 dark:text-dark-subtext mb-10 max-w-2xl mx-auto">El depósito de análisis, investigaciones e hipótesis que alimentan futuras estrategias.</p>
          ${ideaForge.length === 0 ? `<div class="text-center py-12 bg-slate-50 dark:bg-dark-card/30 rounded-2xl border border-dashed border-slate-300 dark:border-dark-border"><p class="text-slate-400 dark:text-dark-subtext">No hay documentos en la fragua aún.</p></div>` : `<div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="ideaGrid"></div>`}
        </div>`;

      const categories = ['Todos', ...CATEGORY_OPTIONS.map(formatCategory)];
      const filterButtons = document.getElementById('filterButtons');
      categories.forEach((cat, idx) => {
        const btn = document.createElement('button');
        btn.textContent = cat === 'Todos' ? 'Todos los proyectos' : cat;
        btn.className = 'filter-btn px-4 py-2 rounded-full text-sm font-semibold transition-all text-brand-dark dark:text-dark-subtext';
        btn.dataset.category = cat;
        filterButtons.appendChild(btn);
        if (idx === 0) {
          btn.classList.add('bg-brand-primary','text-white','shadow-md');
        }
      });

      const cvBtn = document.getElementById('cvBannerBtn');
      if (cvBtn) cvBtn.addEventListener('click', () => { currentView = 'CV'; updateNav(); renderCV(); window.scrollTo({ top: 0, behavior: 'smooth' }); });

      const grid = document.getElementById('projectGrid');
      function paintGrid(active='Todos') {
        const normalized = normalizeCategory(active);
        if (normalized === 'fraguas') {
          grid.innerHTML = ideaForge.map((p,i) => buildProjectCard(p,i)).join('');
          return;
        }
        grid.innerHTML = filtered.filter(p => active==='Todos' || normalizeCategory(p.category)===normalized).map((p,i) => buildProjectCard(p,i)).join('');
      }
      paintGrid();
      filterButtons.addEventListener('click', (e) => {
        const btn = e.target.closest('.filter-btn');
        if (!btn) return;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('bg-brand-primary','text-white','shadow-md'));
        btn.classList.add('bg-brand-primary','text-white','shadow-md');
        paintGrid(btn.dataset.category);
      });

      grid.addEventListener('click', (e) => {
        const card = e.target.closest('[data-id]');
        if (!card) return;
        const project = projects.find(p => p.id === card.dataset.id);
        openModal(project);
      });

      if (ideaForge.length) {
        const ideaGrid = document.getElementById('ideaGrid');
        ideaGrid.innerHTML = ideaForge.map(idea => `
          <div data-id="${idea.id}" class="bg-white dark:bg-dark-card p-6 rounded-xl border border-slate-100 dark:border-dark-border shadow-sm hover:border-brand-primary cursor-pointer transition-all">
            <div class="mb-4 text-brand-primary"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg></div>
            <h4 class="font-bold text-brand-dark dark:text-white mb-2">${idea.title}</h4>
            <p class="text-xs text-slate-500 dark:text-dark-subtext line-clamp-3">${idea.subtitle}</p>
          </div>`).join('');
        ideaGrid.addEventListener('click', (e) => {
          const card = e.target.closest('[data-id]');
          if (!card) return;
          const project = projects.find(p => p.id === card.dataset.id);
          openModal(project);
        });
      }
    }

    function openModal(project) {
      const modal = document.getElementById('projectModal');
      const content = document.getElementById('modalContent');
      if (!project) return;
      content.innerHTML = `
        <div class="h-64 md:h-80 w-full relative">
          <img src="${project.thumbnailUrl}" alt="${project.title}" class="w-full h-full object-cover" />
          <div class="absolute inset-0 bg-gradient-to-t from-white dark:from-black to-transparent"></div>
          <div class="absolute bottom-6 left-6 md:left-10">
            <span class="bg-brand-primary text-white text-xs font-bold px-3 py-1 rounded mb-3 inline-block">${formatCategory(project.category)}</span>
            <h2 class="text-3xl md:text-5xl font-bold text-brand-dark dark:text-white leading-tight">${project.title}</h2>
          </div>
        </div>
        <div class="p-6 md:p-10 space-y-12">
          <div>
            <h3 class="text-sm font-bold text-brand-secondary dark:text-brand-secondary uppercase tracking-widest mb-4">Resumen</h3>
            <p class="text-lg md:text-xl text-slate-700 dark:text-slate-200 leading-relaxed font-playfair italic">${project.subtitle}</p>
          </div>
          ${project.sections.map(section => renderSection(section)).join('') || '<p class="text-slate-500 dark:text-dark-subtext">Sin secciones adicionales.</p>'}
        </div>`;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function renderSection(section) {
      if (section.type === 'TEXT') {
        return `<div class="border-t border-slate-100 dark:border-white/10 pt-8"><h3 class="text-xl font-bold text-brand-dark dark:text-brand-primary mb-6">${section.title}</h3><div class="prose dark:prose-invert max-w-none text-slate-600 dark:text-slate-300"><p>${section.content}</p></div></div>`;
      }
      if (section.type === 'BRIEF') {
        const entries = Object.entries(section.content).map(([k,v]) => `<div class="bg-slate-50 dark:bg-white/5 p-4 rounded-xl"><h4 class="text-xs font-bold text-brand-secondary dark:text-brand-secondary uppercase mb-2">${k}</h4><p class="text-sm text-slate-700 dark:text-slate-300">${v}</p></div>`).join('');
        return `<div class="border-t border-slate-100 dark:border-white/10 pt-8"><h3 class="text-xl font-bold text-brand-dark dark:text-brand-primary mb-6">${section.title}</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6">${entries}</div></div>`;
      }
      if (section.type === 'FLOWCHART') {
        const entries = Object.entries(section.content).map(([k,v]) => `<div class="bg-white dark:bg-black/40 border border-brand-primary/20 dark:border-brand-primary/30 rounded-2xl p-4"><p class="text-xs font-bold text-brand-secondary dark:text-brand-primary uppercase mb-2">${k}</p><p class="text-sm text-brand-dark dark:text-dark-subtext">${v}</p></div>`).join('');
        return `<div class="border-t border-slate-100 dark:border-white/10 pt-8"><h3 class="text-xl font-bold text-brand-dark dark:text-brand-primary mb-6">${section.title}</h3><div class="grid gap-4">${entries}</div></div>`;
      }
      if (section.type === 'IMAGE') {
        return `<div class="border-t border-slate-100 dark:border-white/10 pt-8"><h3 class="text-xl font-bold text-brand-dark dark:text-brand-primary mb-6">${section.title}</h3><img src="${section.content}" alt="${section.title}" class="rounded-2xl" /></div>`;
      }
      if (section.type === 'MEDIA') {
        const url = section.content;
        const isVideo = url?.includes('.mp4') || url?.includes('.webm') || section.mediaType === 'video';
        const isPdf = url?.includes('.pdf') || section.mediaType === 'pdf';
        if (isVideo) {
          return `<div class="border-t border-slate-100 dark:border-white/10 pt-8 space-y-4"><h3 class="text-xl font-bold text-brand-dark dark:text-brand-primary mb-2">${section.title}</h3><video controls class="w-full rounded-2xl shadow"><source src="${url}"></video></div>`;
        }
        if (isPdf) {
          return `<div class="border-t border-slate-100 dark:border-white/10 pt-8 space-y-3"><h3 class="text-xl font-bold text-brand-dark dark:text-brand-primary">${section.title}</h3><div class="bg-white dark:bg-dark-card border border-dashed border-brand-primary/30 rounded-xl p-4 text-sm text-slate-700 dark:text-dark-subtext">Vista previa PDF:</div><iframe src="${url}" class="w-full h-80 rounded-xl border border-slate-200 dark:border-white/10"></iframe></div>`;
        }
        return `<div class="border-t border-slate-100 dark:border-white/10 pt-8 space-y-3"><h3 class="text-xl font-bold text-brand-dark dark:text-brand-primary">${section.title}</h3><img src="${url}" alt="${section.title}" class="rounded-2xl max-h-96 object-cover w-full" /></div>`;
      }
      if (section.type === 'MEDIA_PLAN') {
        const rows = Array.isArray(section.content) ? section.content : [];
        const grouped = rows.reduce((acc, row) => {
          const medium = (row.medium || 'IMPRESO').toUpperCase();
          acc[medium] = acc[medium] || [];
          acc[medium].push(row);
          return acc;
        }, {});
        const blocks = Object.entries(grouped).map(([medium, items]) => {
          const cfg = MEDIA_PLAN_CONFIG[medium] || MEDIA_PLAN_CONFIG.IMPRESO;
          const headers = cfg.fields.map(f => `<th class="px-3 py-2 text-left text-[11px] uppercase text-slate-500 dark:text-dark-subtext">${f.label}</th>`).join('') + '<th class="px-3 py-2 text-left text-[11px] uppercase text-slate-500 dark:text-dark-subtext">Total</th>' + (medium === 'TV' ? '<th class="px-3 py-2 text-left text-[11px] uppercase text-slate-500 dark:text-dark-subtext">Rating</th><th class="px-3 py-2 text-left text-[11px] uppercase text-slate-500 dark:text-dark-subtext">CPM</th><th class="px-3 py-2 text-left text-[11px] uppercase text-slate-500 dark:text-dark-subtext">CPPR</th>' : '');
          const body = items.map(item => {
            const total = item.total ?? computePlanRowTotal(item);
            const cells = cfg.fields.map(f => `<td class="px-3 py-2 text-sm text-slate-700 dark:text-slate-200">${item[f.key] || '—'}</td>`).join('');
            const ratingCells = medium === 'TV' ? `<td class="px-3 py-2 text-sm text-slate-700 dark:text-slate-200">${item.ratingPoint || '—'}</td><td class="px-3 py-2 text-sm text-slate-700 dark:text-slate-200">${item.cpm ? formatCurrency(item.cpm) : '—'}</td><td class="px-3 py-2 text-sm text-slate-700 dark:text-slate-200">${item.cppr ? formatCurrency(item.cppr) : '—'}</td>` : '';
            return `<tr class="border-t border-slate-100 dark:border-white/5">${cells}<td class="px-3 py-2 text-sm font-semibold text-brand-primary">${formatCurrency(total)}</td>${ratingCells}</tr>`;
          }).join('');
          const totalMedium = items.reduce((acc, it) => acc + (it.total ?? computePlanRowTotal(it)), 0);
          const commissionRate = cfg.commission || 0;
          const commission = totalMedium * commissionRate;
          return `<div class="space-y-2">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
              <p class="text-lg font-semibold text-brand-dark dark:text-brand-primary">${cfg.label}</p>
              <p class="text-sm text-slate-600 dark:text-dark-subtext">Total ${formatCurrency(totalMedium)} · Comisión ${Math.round(commissionRate*100)}%: ${formatCurrency(commission)}</p>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-left border border-slate-100 dark:border-white/10 rounded-xl overflow-hidden">
                <thead class="bg-slate-50 dark:bg-white/5">${headers}</thead>
                <tbody class="bg-white dark:bg-dark-card">${body}</tbody>
              </table>
            </div>
          </div>`;
        }).join('');
        const mediaSummary = computePlanSummary(rows);
        return `<div class="border-t border-slate-100 dark:border-white/10 pt-8 space-y-4"><h3 class="text-xl font-bold text-brand-dark dark:text-brand-primary">${section.title}</h3><div class="space-y-6">${blocks}</div><div class="bg-slate-50 dark:bg-white/5 border border-dashed border-brand-primary/30 rounded-xl p-4 text-sm flex flex-col gap-1"><span class="font-semibold text-brand-primary">Total plan: ${formatCurrency(mediaSummary.grandTotal)}</span><span class="text-slate-600 dark:text-dark-subtext">Comisión total: ${formatCurrency(mediaSummary.commissionTotal)}</span></div></div>`;
      }
      if (section.type === 'ANEXO') {
        const info = section.content || {};
        return `<div class="border-t border-slate-100 dark:border-white/10 pt-8 space-y-4"><h3 class="text-xl font-bold text-brand-dark dark:text-brand-primary">${section.title}</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${Object.entries(info).map(([k,v]) => `<div class="bg-slate-50 dark:bg-white/5 p-4 rounded-xl"><p class="text-xs font-bold uppercase text-brand-secondary dark:text-brand-primary mb-1">${k}</p><p class="text-sm text-slate-700 dark:text-dark-subtext">${v}</p></div>`).join('')}</div></div>`;
      }
      return '';
    }

    const modalEl = document.getElementById('projectModal');
    document.getElementById('closeModal').addEventListener('click', () => {
      modalEl.classList.add('hidden');
    });
    modalEl.addEventListener('click', (e) => {
      if (e.target === modalEl) modalEl.classList.add('hidden');
    });
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modalEl.classList.contains('hidden')) {
        modalEl.classList.add('hidden');
      }
    });

    function renderCPanel() {
      const section = document.getElementById('cpanelSection');
      section.innerHTML = `
        <div class="bg-white dark:bg-dark-card border border-[#b6d0ff] dark:border-dark-border shadow-neon p-8 rounded-2xl w-full max-w-md mx-auto text-center" id="lockCard">
          <div class="mb-6 text-4xl">🔒</div>
          <h2 class="text-2xl font-bold text-brand-dark dark:text-dark-highlight mb-2">Acceso Restringido</h2>
          <p class="text-slate-500 dark:text-dark-subtext mb-6">Introduce la contraseña maestra para acceder al Panel de Control.</p>
          <div class="space-y-4">
            <input id="passwordInput" type="password" class="w-full p-3 bg-slate-50 dark:bg-black/40 border border-slate-200 dark:border-dark-border rounded-xl text-center text-lg tracking-widest focus:outline-none focus:ring-2 focus:ring-brand-primary dark:text-white" placeholder="•••••••" />
            <p id="authError" class="text-red-500 text-sm hidden">Contraseña incorrecta</p>
            <button id="unlockBtn" class="w-full py-3 bg-brand-primary text-white rounded-xl font-bold hover:bg-brand-dark transition-all shadow-md">Desbloquear</button>
          </div>
        </div>
        <div id="cpanelContent" class="hidden bg-white dark:bg-dark-card border border-[#b6d0ff] dark:border-dark-border rounded-2xl p-6 md:p-8 shadow-neon backdrop-blur-md">
          <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-6">
            <div class="flex items-center gap-2">
              <button id="newBtn" class="px-3 py-2 rounded-lg text-sm font-semibold bg-brand-primary text-white shadow">Nuevo/Editar</button>
              <button id="listBtn" class="px-3 py-2 rounded-lg text-sm font-semibold bg-slate-100 dark:bg-white/10 text-brand-dark dark:text-white">Lista</button>
            </div>
            <div class="flex items-center gap-3 text-xs text-slate-500 dark:text-dark-subtext">
              <span class="px-2 py-1 bg-slate-100 dark:bg-white/10 rounded-full">Categorías: estrategia, diseño, website, varios, fraguas</span>
              <button id="lockBtn" class="text-red-500 hover:underline">Cerrar Sesión</button>
            </div>
          </div>
          <div id="formView" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="space-y-1">
                <label class="text-xs font-semibold text-slate-500 dark:text-slate-400 ml-1">Título</label>
                <input id="titleInput" class="w-full p-3 bg-slate-50 dark:bg-black/30 border border-slate-200 dark:border-dark-border rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-brand-primary outline-none" />
              </div>
              <div class="space-y-1">
                <label class="text-xs font-semibold text-slate-500 dark:text-slate-400 ml-1">Categoría</label>
                <select id="categoryInput" class="w-full p-3 bg-slate-50 dark:bg-black/30 border border-slate-200 dark:border-dark-border rounded-lg text-slate-800 dark:text-white outline-none"></select>
              </div>
              <div class="space-y-1 md:col-span-2">
                <label class="text-xs font-semibold text-slate-500 dark:text-slate-400 ml-1">Subtítulo</label>
                <textarea id="subtitleInput" class="w-full p-3 bg-slate-50 dark:bg-black/30 border border-slate-200 dark:border-dark-border rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-brand-primary outline-none" rows="2"></textarea>
              </div>
              <div class="space-y-1">
                <label class="text-xs font-semibold text-slate-500 dark:text-slate-400 ml-1">Estado</label>
                <select id="statusInput" class="w-full p-3 bg-slate-50 dark:bg-black/30 border border-slate-200 dark:border-dark-border rounded-lg text-slate-800 dark:text-white outline-none">
                  <option value="Real">Real</option>
                  <option value="Ficticio">Ficticio</option>
                  <option value="Estudio de Caso">Estudio de Caso</option>
                </select>
              </div>
              <div class="space-y-1">
                <label class="text-xs font-semibold text-slate-500 dark:text-slate-400 ml-1">Fecha</label>
                <input id="dateInput" type="date" class="w-full p-3 bg-slate-50 dark:bg-black/30 border border-slate-200 dark:border-dark-border rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-brand-primary outline-none" />
              </div>
              <div class="space-y-1 md:col-span-2">
                <label class="text-xs font-semibold text-slate-500 dark:text-slate-400 ml-1">URL de miniatura</label>
                <input id="thumbInput" class="w-full p-3 bg-slate-50 dark:bg-black/30 border border-slate-200 dark:border-dark-border rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-brand-primary outline-none" placeholder="https://" />
              </div>
              <div class="space-y-1 md:col-span-2">
                <label class="text-xs font-semibold text-slate-500 dark:text-slate-400 ml-1">Resumen / Notas</label>
                <textarea id="notesInput" class="w-full p-3 bg-slate-50 dark:bg-black/30 border border-slate-200 dark:border-dark-border rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-brand-primary outline-none" rows="3" placeholder="Describe el objetivo o resultados"></textarea>
              </div>
              <div class="flex flex-wrap gap-4 md:col-span-2">
                <label class="flex items-center gap-2 text-sm text-slate-600 dark:text-dark-subtext"><input id="draftInput" type="checkbox" class="h-4 w-4 text-brand-primary border-slate-300 rounded" /> Guardar como borrador</label>
                <label class="flex items-center gap-2 text-sm text-slate-600 dark:text-dark-subtext"><input id="ideaInput" type="checkbox" class="h-4 w-4 text-brand-primary border-slate-300 rounded" /> Enviar a "Fraguas"</label>
              </div>
              <div class="space-y-1 md:col-span-2">
                <label class="text-xs font-semibold text-slate-500 dark:text-slate-400 ml-1">Programar publicación (automática)</label>
                <input id="scheduleInput" type="datetime-local" class="w-full p-3 bg-slate-50 dark:bg-black/30 border border-slate-200 dark:border-dark-border rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-brand-primary outline-none" />
              </div>
            </div>

            <div class="border border-dashed border-brand-primary/40 dark:border-brand-primary/30 rounded-xl p-4 space-y-3">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-bold text-brand-dark dark:text-brand-highlight">Archivos (png, jpg, video, pdf)</h3>
                <input id="fileInput" type="file" accept="image/png,image/jpeg,video/*,.pdf" multiple class="text-sm" />
              </div>
              <p class="text-xs text-slate-500 dark:text-dark-subtext">Se guardan en la carpeta virtual <code>${uploadDir}/</code> y se pueden usar como miniatura o media.</p>
              <div id="assetList" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
            </div>

            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-bold text-brand-dark dark:text-brand-highlight">Secciones / Anexos</h3>
                <button id="addSectionBtn" class="px-3 py-2 rounded-lg bg-brand-primary text-white text-sm font-semibold">Añadir sección</button>
              </div>
              <div id="sectionList" class="space-y-3"></div>
            </div>

            <button id="publishBtn" class="w-full py-3 bg-brand-primary text-white rounded-xl font-bold hover:bg-brand-dark transition-all shadow-md">Guardar</button>
          </div>

          <div id="listView" class="hidden space-y-4">
            <p class="text-sm text-slate-500 dark:text-dark-subtext">Ordenados por última edición (recientes primero). Desde aquí puedes editar, programar, borrar o marcar como borrador.</p>
            <div id="projectList" class="space-y-3"></div>
          </div>
        </div>`;

      const PASSWORD = 'J162004';
      const categorySelect = document.getElementById('categoryInput');
      CATEGORY_OPTIONS.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = formatCategory(cat);
        categorySelect.appendChild(opt);
      });

      function lockPanel() {
        const lockCard = document.getElementById('lockCard');
        const content = document.getElementById('cpanelContent');
        const pwd = document.getElementById('passwordInput');
        editingId = null;
        sectionDrafts = [];
        assetDrafts = [];
        if (pwd) pwd.value = '';
        if (content) content.classList.add('hidden');
        if (lockCard) lockCard.classList.remove('hidden');
      }

      window.lockPanelSession = lockPanel;

      function switchView(view = 'form') {
        document.getElementById('formView').classList.toggle('hidden', view !== 'form');
        document.getElementById('listView').classList.toggle('hidden', view !== 'list');
        document.getElementById('newBtn').classList.toggle('bg-brand-primary', view === 'form');
        document.getElementById('newBtn').classList.toggle('text-white', view === 'form');
        document.getElementById('listBtn').classList.toggle('bg-brand-primary', view === 'list');
        document.getElementById('listBtn').classList.toggle('text-white', view === 'list');
      }

      function renderAssets() {
        const list = document.getElementById('assetList');
        if (!assetDrafts.length) { list.innerHTML = '<p class="text-xs text-slate-500 dark:text-dark-subtext">Sin archivos cargados.</p>'; return; }
        const thumbValue = document.getElementById('thumbInput').value;
        list.innerHTML = assetDrafts.map(asset => {
          const preview = asset.preview || '';
          const isThumb = thumbValue && (thumbValue === preview || thumbValue === asset.path);
          const downloadHref = preview || asset.path;
          const exportButton = downloadHref
            ? `<a class="text-xs text-brand-secondary export-asset" href="${downloadHref}" download="${asset.name}">Exportar</a>`
            : '<span class="text-xs text-slate-400">Exportar</span>';
          return `
            <div class="border border-slate-200 dark:border-dark-border rounded-lg p-3 flex items-center gap-3" data-asset-id="${asset.id}">
              <div class="w-12 h-12 bg-slate-100 dark:bg-white/10 rounded overflow-hidden flex items-center justify-center">
                ${preview ? `<img src="${preview}" alt="${asset.name}" class="w-full h-full object-cover" />` : '<span class="text-[10px] text-slate-500 dark:text-dark-subtext">${asset.mediaType === 'pdf' ? 'PDF' : 'Media'}</span>'}
              </div>
              <div class="flex-1">
                <p class="text-sm font-semibold text-brand-dark dark:text-white line-clamp-1">${asset.name} ${isThumb ? '• Miniatura' : ''}</p>
                <p class="text-[11px] text-slate-500 dark:text-dark-subtext">${asset.path}</p>
              </div>
              <div class="flex flex-col gap-1 text-right">
                <button class="text-xs text-brand-primary set-thumb">Usar miniatura</button>
                ${exportButton}
                <button class="text-xs text-red-500 remove-asset">Quitar</button>
              </div>
            </div>`;
        }).join('');
      }

      function renderSections() {
        const list = document.getElementById('sectionList');
        if (!sectionDrafts.length) { list.innerHTML = '<p class="text-sm text-slate-500 dark:text-dark-subtext">Sin secciones. Usa "Añadir sección" para agregar texto, brief, flujogramas, anexos o media.</p>'; return; }
        list.innerHTML = sectionDrafts.map(sec => {
          const briefFields = BRIEF_FIELDS.map(field => `
            <label class="text-[11px] font-semibold text-slate-500 dark:text-slate-300">${field.label}
              <textarea data-brief="${field.key}" class="section-brief w-full p-2 rounded bg-slate-50 dark:bg-black/40 border border-slate-200 dark:border-dark-border text-sm" rows="2">${sec.brief?.[field.key] || ''}</textarea>
            </label>`).join('');

          const flowFields = FLOW_FIELDS.map(field => `
            <label class="text-[11px] font-semibold text-slate-500 dark:text-slate-300">${field.label}
              <textarea data-flow="${field.key}" class="section-flow w-full p-2 rounded bg-slate-50 dark:bg-black/40 border border-slate-200 dark:border-dark-border text-sm" rows="2">${sec.flow?.[field.key] || ''}</textarea>
            </label>`).join('');

          const planRows = (sec.mediaPlan || [createEmptyPlanRow()]).map((row, idx) => {
            const current = MEDIA_PLAN_CONFIG[row.medium] ? row.medium : 'IMPRESO';
            const cfg = MEDIA_PLAN_CONFIG[current];
            const fields = cfg.fields.map(field => `
              <label class="text-[11px] font-semibold text-slate-500 dark:text-slate-300 flex flex-col gap-1">
                ${field.label}${field.helper ? ` <span class="text-[10px] font-normal text-slate-400 dark:text-dark-subtext">${field.helper}</span>` : ''}
                <input data-plan-field="${field.key}" type="${field.type || 'text'}" class="p-2 rounded bg-slate-50 dark:bg-black/40 border border-slate-200 dark:border-dark-border text-xs" value="${row[field.key] || ''}" placeholder="${field.label}">
              </label>
            `).join('');
            const total = computePlanRowTotal(row);
            const ratingVal = Number(row.ratingPoint || 0);
            const costVal = Number(row.costo || total || 0);
            const cpmVal = ratingVal ? costVal / (ratingVal * 1000) : 0;
            const cpprVal = ratingVal ? costVal / ratingVal : 0;
            const ratingDetails = current === 'TV' ? `<p class="text-[11px] text-slate-500 dark:text-dark-subtext">CPM aprox: ${formatCurrency(cpmVal)} · CPPR: ${formatCurrency(cpprVal)}</p>` : '';
            const options = Object.entries(MEDIA_PLAN_CONFIG).map(([key, conf]) => `<option value="${key}" ${current===key?'selected':''}>${conf.label}</option>`).join('');
            return `
            <div class="border border-slate-200 dark:border-dark-border rounded-lg p-3 space-y-3" data-plan-row="${idx}">
              <div class="flex flex-col md:flex-row md:items-center gap-2 text-xs">
                <label class="flex-1 text-[11px] font-semibold text-slate-500 dark:text-slate-300">Tipo de medio
                  <select data-plan-medium class="w-full mt-1 p-2 rounded bg-slate-50 dark:bg-black/40 border border-slate-200 dark:border-dark-border">${options}</select>
                </label>
                <p class="text-[11px] font-semibold text-brand-primary">Total: ${formatCurrency(total)}</p>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-2">${fields}</div>
              ${ratingDetails}
              <button class="text-xs text-red-500 remove-plan-row">Quitar cuadro</button>
            </div>`;
          }).join('');
          const mediaSummary = computePlanSummary(sec.mediaPlan || []);
          const summaryBlock = mediaSummary.summary.length ? `
            <div class="bg-slate-50 dark:bg-black/40 border border-dashed border-brand-primary/30 rounded-lg p-3 text-xs space-y-2">
              <p class="font-semibold text-brand-primary">Totales y comisión</p>
              ${mediaSummary.summary.map(item => `<div class="flex justify-between"><span>${MEDIA_PLAN_CONFIG[item.medium]?.label || item.medium}</span><span>${formatCurrency(item.total)} · Comisión ${Math.round((MEDIA_PLAN_CONFIG[item.medium]?.commission||0)*100)}%: ${formatCurrency(item.commission)}</span></div>`).join('')}
              <div class="flex justify-between font-semibold text-brand-dark dark:text-white pt-2 border-t border-slate-200 dark:border-dark-border"><span>Total plan</span><span>${formatCurrency(mediaSummary.grandTotal)} · Comisión total: ${formatCurrency(mediaSummary.commissionTotal)}</span></div>
            </div>` : '';

          let specificBlock = `<textarea class="section-body w-full p-3 rounded bg-slate-50 dark:bg-black/40 border border-slate-200 dark:border-dark-border text-sm" rows="3" placeholder="Contenido o notas">${sec.body || ''}</textarea>`;

          if (sec.type === 'BRIEF') specificBlock = `<div class="grid grid-cols-1 md:grid-cols-2 gap-3">${briefFields}</div>`;
          if (sec.type === 'FLOWCHART') specificBlock = `<div class="grid grid-cols-1 md:grid-cols-2 gap-3">${flowFields}</div>`;
          if (sec.type === 'MEDIA_PLAN') specificBlock = `
            <div class="space-y-3">
              <p class="text-xs text-slate-500 dark:text-dark-subtext">Plan de medios por formato con cálculo automático de totales, comisión y métricas de TV.</p>
              <div class="space-y-2" data-plan-container>${planRows}</div>
              ${summaryBlock}
              <button class="text-xs text-brand-primary add-plan-row">Añadir cuadro</button>
            </div>`;
          if (sec.type === 'MEDIA') specificBlock = `
            <div class="grid grid-cols-2 gap-2 text-xs">
              <input class="section-media-url p-2 rounded bg-slate-50 dark:bg-black/40 border border-slate-200 dark:border-dark-border" placeholder="URL media / archivo" value="${sec.mediaUrl || ''}">
              <select class="section-media-type p-2 rounded bg-slate-50 dark:bg-black/40 border border-slate-200 dark:border-dark-border">
                <option value="imagen" ${sec.mediaType==='imagen'?'selected':''}>Imagen</option>
                <option value="video" ${sec.mediaType==='video'?'selected':''}>Video</option>
                <option value="pdf" ${sec.mediaType==='pdf'?'selected':''}>PDF</option>
              </select>
            </div>`;
          if (sec.type === 'ANEXO') specificBlock = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-xs">
              <input class="section-extra-evento p-2 rounded bg-slate-50 dark:bg-black/40 border border-slate-200 dark:border-dark-border" placeholder="Evento/actividad" value="${sec.evento || ''}">
              <input class="section-extra-lugar p-2 rounded bg-slate-50 dark:bg-black/40 border border-slate-200 dark:border-dark-border" placeholder="Lugar / URL" value="${sec.lugar || ''}">
              <input class="section-extra-fecha p-2 rounded bg-slate-50 dark:bg-black/40 border border-slate-200 dark:border-dark-border" placeholder="Fecha" value="${sec.fecha || ''}">
            </div>
            <input class="section-media-url p-2 rounded bg-slate-50 dark:bg-black/40 border border-slate-200 dark:border-dark-border text-xs mt-2" placeholder="Enlace o archivo del evento" value="${sec.mediaUrl || ''}">`;

          return `
          <div class="border border-slate-200 dark:border-dark-border rounded-lg p-4 space-y-3" data-section-id="${sec.id}">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-center">
              <input class="section-title md:col-span-2 p-2 rounded bg-slate-50 dark:bg-black/40 border border-slate-200 dark:border-dark-border" placeholder="Título de sección" value="${sec.title || ''}" />
              <select class="section-type p-2 rounded bg-slate-50 dark:bg-black/40 border border-slate-200 dark:border-dark-border">
                <option value="TEXT" ${sec.type==='TEXT'?'selected':''}>Texto</option>
                <option value="BRIEF" ${sec.type==='BRIEF'?'selected':''}>Brief</option>
                <option value="FLOWCHART" ${sec.type==='FLOWCHART'?'selected':''}>Flowchart</option>
                <option value="MEDIA_PLAN" ${sec.type==='MEDIA_PLAN'?'selected':''}>Plan de medios</option>
                <option value="MEDIA" ${sec.type==='MEDIA'?'selected':''}>Media (img/video/pdf)</option>
                <option value="ANEXO" ${sec.type==='ANEXO'?'selected':''}>Anexo</option>
              </select>
              <button class="remove-section text-red-500 text-sm">Eliminar</button>
            </div>
            ${specificBlock}
          </div>`;
        }).join('');
      }

      function setAutoDate(isScheduled = false, value = '') {
        const dateInput = document.getElementById('dateInput');
        const today = new Date().toISOString().slice(0,10);
        dateInput.value = value || today;
        dateInput.disabled = !isScheduled;
        dateInput.readOnly = !isScheduled;
        dateInput.classList.toggle('opacity-70', !isScheduled);
      }

      function mapSectionToDraft(sec) {
        const draft = createEmptySection(sec.type || 'TEXT');
        draft.id = sec.id || Date.now().toString();
        draft.title = sec.title || '';
        draft.mediaType = sec.mediaType || 'imagen';
        if (sec.type === 'BRIEF') {
          draft.brief = { ...draft.brief, ...(sec.content || {}) };
        } else if (sec.type === 'FLOWCHART') {
          draft.flow = { ...draft.flow, ...(sec.content || {}) };
        } else if (sec.type === 'MEDIA_PLAN') {
          if (Array.isArray(sec.content)) {
            draft.mediaPlan = sec.content.map(r => {
              const mediumRaw = (r.medium || r.Medium || '').toUpperCase();
              const medium = MEDIA_PLAN_CONFIG[mediumRaw] ? mediumRaw : 'IMPRESO';
              const row = createEmptyPlanRow(medium);
              Object.keys(row).forEach(key => {
                if (r[key] !== undefined) row[key] = r[key];
              });
              if (r.canal) row.medio = r.canal;
              if (r.formato && row.formato === '') row.formato = r.formato;
              if ((r.ventana || r.fecha) && row.dia !== undefined) row.dia = r.ventana || r.fecha;
              if ((r.ventana || r.fecha) && row.tiempo !== undefined && !row.dia) row.tiempo = r.ventana || r.fecha;
              return row;
            });
          }
        } else if (sec.type === 'MEDIA') {
          draft.mediaUrl = typeof sec.content === 'string' ? sec.content : sec.content?.url || '';
        } else if (sec.type === 'ANEXO') {
          draft.evento = sec.content?.Evento || sec.content?.evento || '';
          draft.lugar = sec.content?.Lugar || sec.content?.lugar || '';
          draft.fecha = sec.content?.Fecha || sec.content?.fecha || '';
          draft.mediaUrl = sec.content?.Enlace || sec.content?.enlace || '';
        } else {
          draft.body = typeof sec.content === 'string' ? sec.content : '';
        }
        if (sec.body) draft.body = sec.body;
        return draft;
      }

      function resetForm(project) {
        document.getElementById('titleInput').value = project?.title || '';
        document.getElementById('subtitleInput').value = project?.subtitle || '';
        document.getElementById('categoryInput').value = project?.category || CATEGORY_OPTIONS[0];
        document.getElementById('statusInput').value = project?.tags?.[1] || 'Real';
        document.getElementById('thumbInput').value = project?.thumbnailUrl || '';
        document.getElementById('notesInput').value = project?.sections?.find(s => s.id === 'note')?.content || project?.subtitle || '';
        document.getElementById('draftInput').checked = project?.draft || false;
        document.getElementById('ideaInput').checked = normalizeCategory(project?.category) === 'fraguas' || project?.isIdeaForge;
        const scheduledValue = project?.scheduledAt ? new Date(project.scheduledAt).toISOString().slice(0,16) : '';
        document.getElementById('scheduleInput').value = scheduledValue;
        const dateValue = project?.date ? project.date.split('T')[0] || project.date : '';
        setAutoDate(!!scheduledValue, dateValue);
        sectionDrafts = (project?.sections || []).filter(sec => sec.id !== 'note').map(mapSectionToDraft);
        assetDrafts = project?.assets || [];
        renderSections();
        renderAssets();
      }

      function parseSections() {
        return sectionDrafts.map(sec => {
          const base = { id: sec.id || Date.now().toString(), title: sec.title || 'Sección', type: sec.type || 'TEXT' };
          if (sec.type === 'BRIEF') {
            return { ...base, content: { ...sec.brief } };
          }
          if (sec.type === 'FLOWCHART') {
            return { ...base, content: { ...sec.flow } };
          }
          if (sec.type === 'MEDIA_PLAN') {
            return { ...base, content: (sec.mediaPlan || []).map(row => serializePlanRow(row)) };
          }
          if (sec.type === 'ANEXO') {
            return { ...base, content: { Evento: sec.evento || 'Por definir', Lugar: sec.lugar || '—', Fecha: sec.fecha || '—', Enlace: sec.mediaUrl || '' } };
          }
          if (sec.type === 'MEDIA') {
            return { ...base, content: sec.mediaUrl || sec.body, mediaType: sec.mediaType || 'imagen' };
          }
          return { ...base, content: sec.body || '' };
        });
      }
      function renderProjectList() {
        const list = document.getElementById('projectList');
        const sorted = [...projects].sort((a,b) => (b.updatedAt || 0) - (a.updatedAt || 0));
        list.innerHTML = sorted.map(item => {
          const status = item.draft ? 'Borrador' : (item.scheduledAt ? 'Programado' : 'Publicado');
          return `<div class="border border-slate-200 dark:border-dark-border rounded-lg p-4 flex flex-col md:flex-row md:items-center gap-3" data-project-id="${item.id}">
            <div class="flex-1">
              <p class="text-sm font-semibold text-brand-dark dark:text-white">${item.title}</p>
              <p class="text-xs text-slate-500 dark:text-dark-subtext">${formatCategory(item.category)} · ${status} · editado ${new Date(item.updatedAt || Date.now()).toLocaleString('es-ES')}</p>
            </div>
            <div class="flex gap-2 flex-wrap text-xs">
              <button class="px-3 py-1 rounded bg-brand-primary text-white edit-project">Editar</button>
              <button class="px-3 py-1 rounded bg-slate-100 dark:bg-white/10 toggle-draft">${item.draft ? 'Publicar' : 'Borrador'}</button>
              <button class="px-3 py-1 rounded bg-slate-100 dark:bg-white/10 schedule-project">Programar</button>
              <button class="px-3 py-1 rounded bg-red-500 text-white delete-project">Eliminar</button>
            </div>
          </div>`;
        }).join('');
      }

      window.renderProjectList = renderProjectList;

      document.getElementById('unlockBtn').addEventListener('click', () => {
        const pwd = document.getElementById('passwordInput').value;
        if (pwd === PASSWORD) {
          document.getElementById('authError').classList.add('hidden');
          document.getElementById('lockCard').classList.add('hidden');
          document.getElementById('cpanelContent').classList.remove('hidden');
          switchView('form');
          resetForm();
        } else {
          document.getElementById('authError').classList.remove('hidden');
        }
      });

      document.getElementById('lockBtn').addEventListener('click', () => {
        lockPanel();
      });

      document.getElementById('newBtn').addEventListener('click', () => switchView('form'));
      document.getElementById('listBtn').addEventListener('click', () => { switchView('list'); renderProjectList(); });
      document.getElementById('scheduleInput').addEventListener('input', (e) => {
        const hasValue = !!e.target.value;
        const datePart = hasValue ? e.target.value.split('T')[0] : '';
        setAutoDate(hasValue, datePart);
      });

      document.getElementById('addSectionBtn').addEventListener('click', () => {
        sectionDrafts.push(createEmptySection());
        renderSections();
      });

      document.getElementById('sectionList').addEventListener('input', (e) => {
        const wrapper = e.target.closest('[data-section-id]');
        if (!wrapper) return;
        const sec = sectionDrafts.find(s => s.id === wrapper.dataset.sectionId);
        if (!sec) return;
        if (e.target.classList.contains('section-title')) sec.title = e.target.value;
        if (e.target.classList.contains('section-type')) {
          const preservedTitle = sec.title;
          Object.assign(sec, createEmptySection(e.target.value), { id: sec.id, title: preservedTitle, type: e.target.value });
          renderSections();
          return;
        }
        if (e.target.classList.contains('section-body')) sec.body = e.target.value;
        if (e.target.classList.contains('section-extra-evento')) sec.evento = e.target.value;
        if (e.target.classList.contains('section-extra-lugar')) sec.lugar = e.target.value;
        if (e.target.classList.contains('section-extra-fecha')) sec.fecha = e.target.value;
        if (e.target.classList.contains('section-media-url')) sec.mediaUrl = e.target.value;
        if (e.target.classList.contains('section-media-type')) sec.mediaType = e.target.value;
        if (e.target.dataset.brief) { sec.brief[e.target.dataset.brief] = e.target.value; }
        if (e.target.dataset.flow) { sec.flow[e.target.dataset.flow] = e.target.value; }
        if (e.target.dataset.planField) {
          const rowIdx = parseInt(e.target.closest('[data-plan-row]')?.dataset.planRow || '0', 10);
          if (!sec.mediaPlan[rowIdx]) sec.mediaPlan[rowIdx] = createEmptyPlanRow();
          sec.mediaPlan[rowIdx][e.target.dataset.planField] = e.target.value;
          renderSections();
        }
        if (e.target.dataset.planMedium !== undefined) {
          const rowIdx = parseInt(e.target.closest('[data-plan-row]')?.dataset.planRow || '0', 10);
          sec.mediaPlan[rowIdx] = createEmptyPlanRow(e.target.value);
          renderSections();
        }
      });

      document.getElementById('sectionList').addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-section')) {
          const wrapper = e.target.closest('[data-section-id]');
          sectionDrafts = sectionDrafts.filter(s => s.id !== wrapper.dataset.sectionId);
          renderSections();
        }
        if (e.target.classList.contains('add-plan-row')) {
          const wrapper = e.target.closest('[data-section-id]');
          const sec = sectionDrafts.find(s => s.id === wrapper.dataset.sectionId);
          if (sec) {
            sec.mediaPlan.push(createEmptyPlanRow());
            renderSections();
          }
        }
        if (e.target.classList.contains('remove-plan-row')) {
          const wrapper = e.target.closest('[data-section-id]');
          const sec = sectionDrafts.find(s => s.id === wrapper.dataset.sectionId);
          const rowIdx = parseInt(e.target.closest('[data-plan-row]')?.dataset.planRow || '-1', 10);
          if (sec && rowIdx > -1) {
            sec.mediaPlan.splice(rowIdx,1);
            if (!sec.mediaPlan.length) sec.mediaPlan.push(createEmptyPlanRow());
            renderSections();
          }
        }
      });

      document.getElementById('fileInput').addEventListener('change', (e) => {
        const files = Array.from(e.target.files || []);
        files.forEach(file => {
          const id = `${Date.now()}-${file.name}`;
          const path = `${uploadDir}/${file.name}`;
          const asset = { id, name: file.name, path, mediaType: file.type, size: file.size };
          if (file.type.includes('image')) { asset.mediaType = 'image'; }
          if (file.type.includes('video')) { asset.mediaType = 'video'; }
          if (file.type.includes('pdf')) { asset.mediaType = 'pdf'; }
          const reader = new FileReader();
          reader.onload = () => {
            asset.preview = reader.result;
            renderAssets();
          };
          reader.readAsDataURL(file);
          assetDrafts.push(asset);
        });
        const thumbInput = document.getElementById('thumbInput');
        if (!thumbInput.value) {
          const firstImage = assetDrafts.find(a => a.mediaType === 'image');
          if (firstImage) thumbInput.value = firstImage.preview || firstImage.path;
        }
        renderAssets();
      });

      document.getElementById('assetList').addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-asset')) {
          const card = e.target.closest('[data-asset-id]');
          assetDrafts = assetDrafts.filter(a => a.id !== card.dataset.assetId);
          renderAssets();
        }
        if (e.target.classList.contains('set-thumb')) {
          const card = e.target.closest('[data-asset-id]');
          const asset = assetDrafts.find(a => a.id === card.dataset.assetId);
          if (asset) {
            document.getElementById('thumbInput').value = asset.preview || asset.path;
            renderAssets();
          }
        }
      });

      document.getElementById('publishBtn').addEventListener('click', () => {
        const title = document.getElementById('titleInput').value.trim();
        const subtitle = document.getElementById('subtitleInput').value.trim();
        if (!title || !subtitle) { alert('Añade al menos título y subtítulo.'); return; }
        const category = document.getElementById('categoryInput').value;
        const status = document.getElementById('statusInput').value;
        const date = document.getElementById('dateInput').value;
        const thumb = document.getElementById('thumbInput').value || 'https://via.placeholder.com/600x400';
        const notes = document.getElementById('notesInput').value;
        const idea = document.getElementById('ideaInput').checked || category === 'fraguas';
        const draft = document.getElementById('draftInput').checked;
        const scheduledAt = document.getElementById('scheduleInput').value ? new Date(document.getElementById('scheduleInput').value).getTime() : null;
        const displayDate = date ? new Date(date).toLocaleDateString('es-ES', { month: 'short', year: 'numeric' }) : 'sin fecha';
        const compiledSections = parseSections();
        if (notes && !compiledSections.some(s => s.id === 'note')) {
          compiledSections.unshift({ id: 'note', title: 'Notas', type: 'TEXT', content: notes });
        }
        const newProject = {
          id: editingId || Date.now().toString(),
          title,
          subtitle,
          category: normalizeCategory(category),
          tags: [displayDate, status],
          thumbnailUrl: thumb,
          date: date || new Date().toISOString().slice(0,10),
          sections: compiledSections,
          isIdeaForge: idea,
          draft,
          updatedAt: Date.now(),
          scheduledAt,
          assets: assetDrafts
        };
        projects = editingId ? projects.map(p => p.id === editingId ? newProject : p) : [newProject, ...projects];
        saveProjects();
        renderPortfolio();
        renderProjectList();
        switchView('list');
        editingId = null;
        alert('Guardado.');
      });

      document.getElementById('projectList').addEventListener('click', (e) => {
        const card = e.target.closest('[data-project-id]');
        if (!card) return;
        const project = projects.find(p => p.id === card.dataset.projectId);
        if (e.target.classList.contains('edit-project')) {
          editingId = project.id;
          resetForm(project);
          switchView('form');
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        if (e.target.classList.contains('delete-project')) {
          if (confirm('¿Eliminar este proyecto?')) {
            projects = projects.filter(p => p.id !== project.id);
            saveProjects();
            renderPortfolio();
            renderProjectList();
          }
        }
        if (e.target.classList.contains('toggle-draft')) {
          project.draft = !project.draft;
          project.scheduledAt = null;
          project.updatedAt = Date.now();
          saveProjects();
          renderPortfolio();
          renderProjectList();
        }
        if (e.target.classList.contains('schedule-project')) {
          const when = prompt('Fecha y hora (YYYY-MM-DD hh:mm):');
          if (when) {
            const ts = new Date(when).getTime();
            if (!isNaN(ts)) {
              project.scheduledAt = ts;
              project.draft = true;
              project.updatedAt = Date.now();
              saveProjects();
              renderProjectList();
              processSchedules();
            }
          }
        }
      });

      function resetSectionsOnLoad() {
        sectionDrafts = [];
        assetDrafts = [];
        renderSections();
        renderAssets();
        if (typeof setAutoDate === 'function') setAutoDate(false, '');
      }

      resetSectionsOnLoad();
      renderProjectList();
    }

    function renderChatbot() {
      const container = document.getElementById('chatbotSection');
      if (!container) return;
      container.innerHTML = `
        <div class="bg-white dark:bg-dark-card border border-[#b6d0ff] dark:border-dark-border rounded-3xl shadow-lg p-8 md:p-12">
          <p class="text-[11px] uppercase tracking-[0.25em] text-brand-primary font-bold mb-2">ChatBot</p>
          <h2 class="text-3xl md:text-4xl font-bold text-brand-dark dark:text-white mb-4">Asistente en preparación</h2>
          <p class="text-slate-600 dark:text-dark-subtext max-w-2xl mb-6">Pronto volverá el chatbot híbrido con las preguntas más frecuentes y recomendaciones personalizadas. Mientras tanto, puedes explorar mi portafolio o contactar directo desde el panel.</p>
          <div class="flex flex-wrap gap-3">
            <button class="px-4 py-2 rounded-full bg-brand-primary text-white font-semibold shadow" data-view="PORTFOLIO">Ver portafolio</button>
            <button class="px-4 py-2 rounded-full bg-slate-100 dark:bg-white/10 text-brand-dark dark:text-white font-semibold shadow" data-view="HOME">Volver al inicio</button>
          </div>
        </div>`;

      container.querySelectorAll('button[data-view]').forEach(btn => {
        btn.addEventListener('click', () => {
          currentView = btn.dataset.view;
          updateNav();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      });
    }

    renderProfile();
    renderPortfolio();
    renderChatbot();
    renderCV();
    renderCPanel();
    updateNav();
  </script>
</body>
</html>
